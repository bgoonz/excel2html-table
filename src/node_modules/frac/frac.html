<h1 id="target">Target</h1>
<p>In all languages, the target is a function that takes 3 parameters:</p>
<ul>
<li><code>x</code> the number we wish to approximate</li>
<li><code>D</code> the maximum denominator</li>
<li><code>mixed</code> if true, return a mixed fraction (default); if false, improper</li>
</ul>
<p>The JS implementation walks through the algorithm.</p>
<h1 id="js-implementation">JS Implementation</h1>
<p>In this version, the return value is <code>[quotient, numerator, denominator]</code>, where <code>quotient == 0</code> for improper fractions. The interpretation is <code>x ~ quotient + numerator / denominator</code> where <code>0 &lt;= numerator &lt; denominator</code> and <code>quotient &lt;= x</code> for negative <code>x</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js&gt;frac.js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="co">/* frac.js (C) 2013-2014 SheetJS -- http://sheetjs.com */</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">var</span> frac <span class="op">=</span> <span class="kw">function</span>(x<span class="op">,</span> D<span class="op">,</span> mixed) <span class="op">{</span></a></code></pre></div>
<p>The goal is to maintain a feasible fraction (with bounded denominator) below the target and another fraction above the target. The lower bound is <code>floor(x) / 1</code> and the upper bound is <code>(floor(x) + 1) / 1</code>. We keep track of the numerators and denominators separately:</p>
<pre><code>  var n1 = Math.floor(x), d1 = 1;
  var n2 = n1+1, d2 = 1;</code></pre>
<p>If <code>x</code> is not integral, we bisect using mediants until a denominator exceeds our target:</p>
<pre><code>  if(x !== n1) while(d1 &lt;= D &amp;&amp; d2 &lt;= D) {</code></pre>
<p>The mediant is the sum of the numerators divided by the sum of demoninators:</p>
<pre><code>    var m = (n1 + n2) / (d1 + d2);</code></pre>
<p>If we happened to stumble upon the exact value, then we choose the closer one (the mediant if the denominator is within bounds, or the bound with the larger denominator)</p>
<pre><code>    if(x === m) {
      if(d1 + d2 &lt;= D) { d1+=d2; n1+=n2; d2=D+1; }
      else if(d1 &gt; d2) d2=D+1;
      else d1=D+1;
      break;
    }</code></pre>
<p>Otherwise shrink the range:</p>
<pre><code>    else if(x &lt; m) { n2 = n1+n2; d2 = d1+d2; }
    else { n1 = n1+n2; d1 = d1+d2; }
  }</code></pre>
<p>At this point, <code>d1 &gt; D</code> or <code>d2 &gt; D</code> (but not both – keep track of how <code>d1</code> and <code>d2</code> change). So we merely return the desired values:</p>
<pre><code>  if(d1 &gt; D) { d1 = d2; n1 = n2; }
  if(!mixed) return [0, n1, d1];
  var q = Math.floor(n1/d1);
  return [q, n1 - q*d1, d1];
};</code></pre>
<h2 id="continued-fraction-method">Continued Fraction Method</h2>
<p>The continued fraction technique is employed by various spreadsheet programs. Note that this technique is inferior to the mediant method (at least, according to the desired goal of most accurately approximating the floating point number)</p>
<pre><code>frac.cont = function cont(x, D, mixed) {</code></pre>
<blockquote>
<p>Record the sign of x, take b0=|x|, p_{-2}=0, p_{-1}=1, q_{-2}=1, q_{-1}=0</p>
</blockquote>
<p>Note that the variables are implicitly indexed at <code>k</code> (so <code>B</code> refers to <code>b_k</code>):</p>
<pre><code>  var sgn = x &lt; 0 ? -1 : 1;
  var B = x * sgn;
  var P_2 = 0, P_1 = 1, P = 0;
  var Q_2 = 1, Q_1 = 0, Q = 0;</code></pre>
<p><code>A</code> should be the floor of <code>B</code>. Originally the bit-or trick was used, but this is not correct for the range <code>B&gt;=2**32</code>.</p>
<pre><code>  var A = Math.floor(B);</code></pre>
<blockquote>
<p>Iterate</p>
</blockquote>
<blockquote>
<p>… for k = 0,1,…,K, where K is the first instance of k where either q_{k+1} &gt; Q or b_{k+1} is undefined (b_k = a_k).</p>
</blockquote>
<pre><code>  while(Q_1 &lt; D) {</code></pre>
<blockquote>
<p>a_k = [b_k], i.e., the greatest integer &lt;= b_k</p>
</blockquote>
<pre><code>    A = Math.floor(B);</code></pre>
<blockquote>
<p>p_k = a_k p_{k-1} + p_{k-2} q_k = a_k q_{k-1} + q_{k-2}</p>
</blockquote>
<pre><code>    P = A * P_1 + P_2;
    Q = A * Q_1 + Q_2;</code></pre>
<blockquote>
<p>b_{k+1} = (b_{k} - a_{k})^{-1}</p>
</blockquote>
<pre><code>    if((B - A) &lt; 0.0000000005) break;</code></pre>
<p>At the end of each iteration, advance <code>k</code> by one step:</p>
<pre><code>    B = 1 / (B - A);
    P_2 = P_1; P_1 = P;
    Q_2 = Q_1; Q_1 = Q;
  }</code></pre>
<p>In case we end up overstepping, walk back an iteration or two:</p>
<pre><code>  if(Q &gt; D) { Q = Q_1; P = P_1; }
  if(Q &gt; D) { Q = Q_2; P = P_2; }</code></pre>
<p>The final result is <code>r = (sgn x)p_k / q_k</code>:</p>
<pre><code>  if(!mixed) return [0, sgn * P, Q];
  var q = Math.floor(sgn * P/Q);
  return [q, sgn*P - q*Q, Q];
};</code></pre>
<p>Finally we put some export jazz:</p>
<pre><code>if(typeof module !== &#39;undefined&#39;) module.exports = frac;</code></pre>
<h1 id="tests">Tests</h1>
<div class="sourceCode" id="cb19"><pre class="sourceCode js&gt;test.js"><code class="sourceCode javascript"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">var</span> fs <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;fs&#39;</span>)<span class="op">,</span> assert <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;assert&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-2" title="2"><span class="kw">var</span> frac<span class="op">;</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="at">describe</span>(<span class="st">&#39;source&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span> <span class="at">it</span>(<span class="st">&#39;should load&#39;</span><span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span> frac <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./&#39;</span>)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="kw">var</span> xltestfiles<span class="op">=</span>[</a>
<a class="sourceLine" id="cb19-5" title="5">  [<span class="st">&#39;xl.00001.tsv&#39;</span><span class="op">,</span> <span class="dv">10000</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb19-6" title="6">  [<span class="st">&#39;xl.0001.tsv&#39;</span><span class="op">,</span>  <span class="dv">10000</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb19-7" title="7">  [<span class="st">&#39;xl.001.tsv&#39;</span><span class="op">,</span>   <span class="dv">10000</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb19-8" title="8">  [<span class="st">&#39;xl.01.tsv&#39;</span><span class="op">,</span>    <span class="dv">10000</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb19-9" title="9">  [<span class="st">&#39;oddities.tsv&#39;</span><span class="op">,</span> <span class="dv">25</span>]</a>
<a class="sourceLine" id="cb19-10" title="10">]<span class="op">;</span></a>
<a class="sourceLine" id="cb19-11" title="11"></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="kw">function</span> <span class="at">xlline</span>(o<span class="op">,</span>j<span class="op">,</span>m<span class="op">,</span>w) <span class="op">{</span></a>
<a class="sourceLine" id="cb19-13" title="13">  <span class="at">it</span>(j<span class="op">,</span> <span class="kw">function</span>(done) <span class="op">{</span></a>
<a class="sourceLine" id="cb19-14" title="14">    <span class="kw">var</span> d<span class="op">,</span> q<span class="op">,</span> qq<span class="op">;</span></a>
<a class="sourceLine" id="cb19-15" title="15">    <span class="cf">for</span>(<span class="kw">var</span> i <span class="op">=</span> j<span class="op">*</span>w<span class="op">;</span> i <span class="op">&lt;</span> m<span class="dv">-3</span> <span class="op">&amp;&amp;</span> i <span class="op">&lt;</span> (j<span class="op">+</span><span class="dv">1</span>)<span class="op">*</span>w<span class="op">;</span> <span class="op">++</span>i) <span class="op">{</span></a>
<a class="sourceLine" id="cb19-16" title="16">      d <span class="op">=</span> o[i].<span class="at">split</span>(<span class="st">&quot;</span><span class="sc">\t</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-17" title="17"></a>
<a class="sourceLine" id="cb19-18" title="18">      q <span class="op">=</span> <span class="va">frac</span>.<span class="at">cont</span>(<span class="at">Number</span>(d[<span class="dv">0</span>])<span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-19" title="19">      qq <span class="op">=</span> (q[<span class="dv">0</span>]<span class="op">||</span>q[<span class="dv">1</span>]) <span class="op">?</span> (q[<span class="dv">0</span>] <span class="op">||</span> <span class="st">&quot;&quot;</span>) <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="op">+</span> (q[<span class="dv">1</span>] <span class="op">?</span> q[<span class="dv">1</span>] <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> q[<span class="dv">2</span>] : <span class="st">&quot;   &quot;</span>) : <span class="st">&quot;0    &quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb19-20" title="20">      <span class="va">assert</span>.<span class="at">equal</span>(qq<span class="op">,</span> d[<span class="dv">1</span>]<span class="op">,</span> d[<span class="dv">1</span>] <span class="op">+</span> <span class="st">&quot; 1&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-21" title="21"></a>
<a class="sourceLine" id="cb19-22" title="22">      q <span class="op">=</span> <span class="va">frac</span>.<span class="at">cont</span>(<span class="at">Number</span>(d[<span class="dv">0</span>])<span class="op">,</span> <span class="dv">99</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-23" title="23">      qq <span class="op">=</span> (q[<span class="dv">0</span>]<span class="op">||</span>q[<span class="dv">1</span>]) <span class="op">?</span> (q[<span class="dv">0</span>] <span class="op">||</span> <span class="st">&quot;&quot;</span>) <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="op">+</span> (q[<span class="dv">1</span>] <span class="op">?</span> (q[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">10</span> <span class="op">?</span> <span class="st">&quot; &quot;</span> : <span class="st">&quot;&quot;</span>) <span class="op">+</span> q[<span class="dv">1</span>] <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> q[<span class="dv">2</span>] <span class="op">+</span> (q[<span class="dv">2</span>]<span class="op">&lt;</span><span class="dv">10</span><span class="op">?</span><span class="st">&quot; &quot;</span>:<span class="st">&quot;&quot;</span>) : <span class="st">&quot;     &quot;</span>) : <span class="st">&quot;0      &quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb19-24" title="24">      <span class="va">assert</span>.<span class="at">equal</span>(qq<span class="op">,</span> d[<span class="dv">2</span>]<span class="op">,</span> d[<span class="dv">2</span>] <span class="op">+</span> <span class="st">&quot; 2&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-25" title="25"></a>
<a class="sourceLine" id="cb19-26" title="26">      q <span class="op">=</span> <span class="va">frac</span>.<span class="at">cont</span>(<span class="at">Number</span>(d[<span class="dv">0</span>])<span class="op">,</span> <span class="dv">999</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-27" title="27">      qq <span class="op">=</span> (q[<span class="dv">0</span>]<span class="op">||</span>q[<span class="dv">1</span>]) <span class="op">?</span> (q[<span class="dv">0</span>] <span class="op">||</span> <span class="st">&quot;&quot;</span>) <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="op">+</span> (q[<span class="dv">1</span>] <span class="op">?</span> (q[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">100</span> <span class="op">?</span> <span class="st">&quot; &quot;</span> : <span class="st">&quot;&quot;</span>) <span class="op">+</span> (q[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">10</span> <span class="op">?</span> <span class="st">&quot; &quot;</span> : <span class="st">&quot;&quot;</span>) <span class="op">+</span> q[<span class="dv">1</span>] <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> q[<span class="dv">2</span>] <span class="op">+</span> (q[<span class="dv">2</span>]<span class="op">&lt;</span><span class="dv">10</span><span class="op">?</span><span class="st">&quot; &quot;</span>:<span class="st">&quot;&quot;</span>) <span class="op">+</span> (q[<span class="dv">2</span>]<span class="op">&lt;</span><span class="dv">100</span><span class="op">?</span><span class="st">&quot; &quot;</span>:<span class="st">&quot;&quot;</span>): <span class="st">&quot;       &quot;</span>) : <span class="st">&quot;0        &quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb19-28" title="28">      <span class="va">assert</span>.<span class="at">equal</span>(qq<span class="op">,</span> d[<span class="dv">3</span>]<span class="op">,</span> d[<span class="dv">3</span>] <span class="op">+</span> <span class="st">&quot; 3&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-29" title="29">    <span class="op">}</span></a>
<a class="sourceLine" id="cb19-30" title="30">    <span class="at">done</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb19-31" title="31">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-32" title="32"><span class="op">}</span></a>
<a class="sourceLine" id="cb19-33" title="33"><span class="kw">function</span> <span class="at">parsexl</span>(f<span class="op">,</span>w) <span class="op">{</span></a>
<a class="sourceLine" id="cb19-34" title="34">  <span class="cf">if</span>(<span class="op">!</span><span class="va">fs</span>.<span class="at">existsSync</span>(f)) <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb19-35" title="35">  <span class="kw">var</span> o <span class="op">=</span> <span class="va">fs</span>.<span class="at">readFileSync</span>(f<span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>).<span class="at">split</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-36" title="36">  <span class="cf">for</span>(<span class="kw">var</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> m <span class="op">=</span> <span class="va">o</span>.<span class="at">length</span><span class="dv">-3</span><span class="op">;</span> j <span class="op">&lt;</span> m/w<span class="op">;</span> <span class="op">++</span>j) <span class="at">xlline</span>(o<span class="op">,</span>j<span class="op">,</span>m<span class="op">,</span>w)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-37" title="37"><span class="op">}</span></a>
<a class="sourceLine" id="cb19-38" title="38"><span class="va">xltestfiles</span>.<span class="at">forEach</span>(<span class="kw">function</span>(x) <span class="op">{</span></a>
<a class="sourceLine" id="cb19-39" title="39">  <span class="kw">var</span> f <span class="op">=</span> <span class="st">&#39;./test_files/&#39;</span> <span class="op">+</span> x[<span class="dv">0</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb19-40" title="40">  <span class="at">describe</span>(x[<span class="dv">0</span>]<span class="op">,</span> <span class="kw">function</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb19-41" title="41">    <span class="at">parsexl</span>(f<span class="op">,</span>x[<span class="dv">1</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb19-42" title="42">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-43" title="43"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<h1 id="miscellany">Miscellany</h1>
<pre class="make&gt;makefile"><code>frac.js: frac.md
        voc frac.md

.PHONY: test
test:
        mocha -R spec</code></pre>
<h2 id="node-ilk">Node Ilk</h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode json&gt;package.json"><code class="sourceCode json"><a class="sourceLine" id="cb21-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb21-2" title="2">  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;frac&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb21-3" title="3">  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;0.3.1&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb21-4" title="4">  <span class="dt">&quot;author&quot;</span><span class="fu">:</span> <span class="st">&quot;SheetJS&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb21-5" title="5">  <span class="dt">&quot;description&quot;</span><span class="fu">:</span> <span class="st">&quot;Rational approximation with bounded denominator&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb21-6" title="6">  <span class="dt">&quot;keywords&quot;</span><span class="fu">:</span> <span class="ot">[</span> <span class="st">&quot;math&quot;</span><span class="ot">,</span> <span class="st">&quot;fraction&quot;</span><span class="ot">,</span> <span class="st">&quot;rational&quot;</span><span class="ot">,</span> <span class="st">&quot;approximation&quot;</span> <span class="ot">]</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb21-7" title="7">  <span class="dt">&quot;main&quot;</span><span class="fu">:</span> <span class="st">&quot;./frac.js&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb21-8" title="8">  <span class="dt">&quot;dependencies&quot;</span><span class="fu">:</span> <span class="fu">{},</span></a>
<a class="sourceLine" id="cb21-9" title="9">  <span class="dt">&quot;devDependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;mocha&quot;</span><span class="fu">:</span><span class="st">&quot;&quot;</span><span class="fu">,</span><span class="dt">&quot;voc&quot;</span><span class="fu">:</span><span class="st">&quot;&quot;</span><span class="fu">},</span></a>
<a class="sourceLine" id="cb21-10" title="10">  <span class="dt">&quot;repository&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb21-11" title="11">    <span class="dt">&quot;type&quot;</span><span class="fu">:</span><span class="st">&quot;git&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb21-12" title="12">    <span class="dt">&quot;url&quot;</span><span class="fu">:</span> <span class="st">&quot;git://github.com/SheetJS/frac.git&quot;</span></a>
<a class="sourceLine" id="cb21-13" title="13">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb21-14" title="14">  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb21-15" title="15">    <span class="dt">&quot;test&quot;</span><span class="fu">:</span> <span class="st">&quot;make test&quot;</span></a>
<a class="sourceLine" id="cb21-16" title="16">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb21-17" title="17">  <span class="dt">&quot;bugs&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://github.com/SheetJS/frac/issues&quot;</span> <span class="fu">},</span></a>
<a class="sourceLine" id="cb21-18" title="18">  <span class="dt">&quot;engines&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;node&quot;</span><span class="fu">:</span> <span class="st">&quot;&gt;=0.8&quot;</span> <span class="fu">}</span></a>
<a class="sourceLine" id="cb21-19" title="19"><span class="fu">}</span></a></code></pre></div>
<p>And to make sure that test files are not included in npm:</p>
<pre class="&gt;.npmignore"><code>test_files/*.tsv</code></pre>
<pre class="&gt;.gitignore"><code>.gitignore
.npmignore</code></pre>
