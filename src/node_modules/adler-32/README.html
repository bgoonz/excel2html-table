<h1 id="adler32">adler32</h1>
<p>Signed ADLER-32 algorithm implementation in JS (for the browser and nodejs). Emphasis on correctness, performance, and IE6+ support.</p>
<h2 id="installation">Installation</h2>
<p>With <a href="https://www.npmjs.org/package/adler-32">npm</a>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1">$ <span class="ex">npm</span> install adler-32</a></code></pre></div>
<p>In the browser:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;adler32.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></a></code></pre></div>
<p>The browser exposes a variable <code>ADLER32</code>.</p>
<p>When installed globally, npm installs a script <code>adler32</code> that computes the checksum for a specified file or standard input.</p>
<p>The script will manipulate <code>module.exports</code> if available . This is not always desirable. To prevent the behavior, define <code>DO_NOT_EXPORT_ADLER</code>.</p>
<h2 id="usage">Usage</h2>
<p>In all cases, the relevant function takes an argument representing data and an optional second argument representing the starting ‚Äúseed‚Äù (for running hash).</p>
<p>The return value is a signed 32-bit integer.</p>
<ul>
<li><p><code>ADLER32.buf(byte array or buffer[, seed])</code> assumes the argument is a sequence of 8-bit unsigned integers (nodejs <code>Buffer</code>, <code>Uint8Array</code> or array of bytes).</p></li>
<li><p><code>ADLER32.bstr(binary string[, seed])</code> assumes the argument is a binary string where byte <code>i</code> is the low byte of the UCS-2 char: <code>str.charCodeAt(i) &amp; 0xFF</code></p></li>
<li><p><code>ADLER32.str(string)</code> assumes the argument is a standard JS string and calculates the hash of the UTF-8 encoding.</p></li>
</ul>
<p>For example:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="co">// var ADLER32 = require(&#39;adler-32&#39;);           // uncomment if in node</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="va">ADLER32</span>.<span class="at">str</span>(<span class="st">&quot;SheetJS&quot;</span>)                          <span class="co">// 176947863</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="va">ADLER32</span>.<span class="at">bstr</span>(<span class="st">&quot;SheetJS&quot;</span>)                         <span class="co">// 176947863</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="va">ADLER32</span>.<span class="at">buf</span>([ <span class="dv">83</span><span class="op">,</span> <span class="dv">104</span><span class="op">,</span> <span class="dv">101</span><span class="op">,</span> <span class="dv">101</span><span class="op">,</span> <span class="dv">116</span><span class="op">,</span> <span class="dv">74</span><span class="op">,</span> <span class="dv">83</span> ]) <span class="co">// 176947863</span></a>
<a class="sourceLine" id="cb3-5" title="5"></a>
<a class="sourceLine" id="cb3-6" title="6">adler32 <span class="op">=</span> <span class="va">ADLER32</span>.<span class="at">buf</span>([<span class="dv">83</span><span class="op">,</span> <span class="dv">104</span>])                <span class="co">// 17825980  &quot;Sh&quot;</span></a>
<a class="sourceLine" id="cb3-7" title="7">adler32 <span class="op">=</span> <span class="va">ADLER32</span>.<span class="at">str</span>(<span class="st">&quot;eet&quot;</span><span class="op">,</span> adler32)           <span class="co">// 95486458  &quot;Sheet&quot;</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="va">ADLER32</span>.<span class="at">bstr</span>(<span class="st">&quot;JS&quot;</span><span class="op">,</span> adler32)                     <span class="co">// 176947863  &quot;SheetJS&quot;</span></a>
<a class="sourceLine" id="cb3-9" title="9"></a>
<a class="sourceLine" id="cb3-10" title="10">[<span class="va">ADLER32</span>.<span class="at">str</span>(<span class="st">&quot;</span><span class="sc">\u2603</span><span class="st">&quot;</span>)<span class="op">,</span>  <span class="va">ADLER32</span>.<span class="at">str</span>(<span class="st">&quot;</span><span class="sc">\u0003</span><span class="st">&quot;</span>)]  <span class="co">// [ 73138686, 262148 ]</span></a>
<a class="sourceLine" id="cb3-11" title="11">[<span class="va">ADLER32</span>.<span class="at">bstr</span>(<span class="st">&quot;</span><span class="sc">\u2603</span><span class="st">&quot;</span>)<span class="op">,</span> <span class="va">ADLER32</span>.<span class="at">bstr</span>(<span class="st">&quot;</span><span class="sc">\u0003</span><span class="st">&quot;</span>)] <span class="co">// [ 262148,   262148 ]</span></a>
<a class="sourceLine" id="cb3-12" title="12">[<span class="va">ADLER32</span>.<span class="at">buf</span>([<span class="bn">0x2603</span>])<span class="op">,</span>  <span class="va">ADLER32</span>.<span class="at">buf</span>([<span class="bn">0x0003</span>])]  <span class="co">// [ 262148,   262148 ]</span></a></code></pre></div>
<h2 id="testing">Testing</h2>
<p><code>make test</code> will run the nodejs-based test.</p>
<p>To run the in-browser tests, run a local server and go to the <code>ctest</code> directory. <code>make ctestserv</code> will start a python <code>SimpleHTTPServer</code> server on port 8000.</p>
<p>To update the browser artifacts, run <code>make ctest</code>.</p>
<p>To generate the bits file, use the <code>adler32</code> function from python <code>zlib</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" title="1"><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> zlib <span class="im">import</span> adler32</a>
<a class="sourceLine" id="cb4-2" title="2"><span class="op">&gt;&gt;&gt;</span> x<span class="op">=</span><span class="st">&quot;foo bar bazŸ™‚òÉüç£&quot;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="op">&gt;&gt;&gt;</span> adler32(x)</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="dv">1543572022</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="op">&gt;&gt;&gt;</span> adler32(x<span class="op">+</span>x)</a>
<a class="sourceLine" id="cb4-6" title="6"><span class="dv">-2076896149</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="op">&gt;&gt;&gt;</span> adler32(x<span class="op">+</span>x<span class="op">+</span>x)</a>
<a class="sourceLine" id="cb4-8" title="8"><span class="dv">2023497376</span></a></code></pre></div>
<p>The included <code>adler32.njs</code> script can process files or standard input:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" title="1">$ <span class="bu">echo</span> <span class="st">&quot;this is a test&quot;</span> <span class="op">&gt;</span> t.txt</a>
<a class="sourceLine" id="cb5-2" title="2">$ <span class="ex">bin/adler32.njs</span> t.txt</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="ex">726861088</span></a></code></pre></div>
<p>For comparison, the included <code>adler32.py</code> script uses python <code>zlib</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" title="1">$ <span class="ex">bin/adler32.py</span> t.txt</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="ex">726861088</span></a></code></pre></div>
<h2 id="performance">Performance</h2>
<p><code>make perf</code> will run algorithmic performance tests (which should justify certain decisions in the code).</p>
<p>Bit twiddling is much faster than taking the mod in Safari and Firefox browsers. Instead of taking the literal mod 65521, it is faster to keep it in the integers by bit-shifting: <code>65536 ~ 15 mod 65521</code> so for nonnegative integer <code>a</code>:</p>
<pre><code>    a = (a &gt;&gt;&gt; 16) * 65536 + (a &amp; 65535)            [equality]
    a ~ (a &gt;&gt;&gt; 16) * 15    + (a &amp; 65535) mod 65521</code></pre>
<p>The mod is taken at the very end, since the intermediate result may exceed 65521</p>
<h2 id="magic-number">Magic Number</h2>
<p>The magic numbers were chosen so as to not overflow a 31-bit integer:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode mathematica"><code class="sourceCode mathematica"><a class="sourceLine" id="cb8-1" title="1"><span class="fu">F</span>[<span class="dt">n_</span>] := <span class="fu">Reduce</span>[<span class="fu">x</span>*(<span class="fu">x</span> + <span class="dv">1</span>)*<span class="fu">n</span>/<span class="dv">2</span> + (<span class="fu">x</span> + <span class="dv">1</span>)*(<span class="dv">65521</span>) &lt; (<span class="dv">2</span>^<span class="dv">31</span> - <span class="dv">1</span>) &amp;&amp; <span class="fu">x</span> &gt; <span class="dv">0</span>, <span class="fu">x</span>, <span class="fu">Integers</span>]</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="fu">F</span>[<span class="dv">255</span>] (* bstr:  <span class="fu">x</span> \[<span class="fu">Element</span>] <span class="fu">Integers</span> &amp;&amp; <span class="dv">1</span> &lt;= <span class="fu">x</span> &lt;= <span class="dv">3854</span> *)</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="fu">F</span>[<span class="dv">127</span>] (* ascii: <span class="fu">x</span> \[<span class="fu">Element</span>] <span class="fu">Integers</span> &amp;&amp; <span class="dv">1</span> &lt;= <span class="fu">x</span> &lt;= <span class="dv">5321</span> *)</a></code></pre></div>
<p>Subtract up to 4 elements for the Unicode case.</p>
<h2 id="license">License</h2>
<p>Please consult the attached LICENSE file for details. All rights not explicitly granted by the Apache 2.0 license are reserved by the Original Author.</p>
<h2 id="badges">Badges</h2>
<p><a href="https://saucelabs.com/u/adler32"><img src="https://saucelabs.com/browser-matrix/adler32.svg" alt="Sauce Test Status" /></a></p>
<p><a href="https://travis-ci.org/SheetJS/js-adler32"><img src="https://travis-ci.org/SheetJS/js-adler32.svg?branch=master" alt="Build Status" /></a></p>
<p><a href="https://coveralls.io/r/SheetJS/js-adler32?branch=master"><img src="http://img.shields.io/coveralls/SheetJS/js-adler32/master.svg" alt="Coverage Status" /></a></p>
<p><a href="https://github.com/SheetJS/js-adler32"><img src="https://ga-beacon.appspot.com/UA-36810333-1/SheetJS/js-adler32?pixel" alt="Analytics" /></a></p>
