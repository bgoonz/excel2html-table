<h1 id="exit-on-epipe">exit-on-epipe</h1>
<p>Cleanly exit on pipe errors in NodeJS scripts.</p>
<p>NOTE: The underlying problem was addressed in 8.x NodeJS versions but the fix was not backported to 6.x and other versions of NodeJS.</p>
<p>These errors are common in pipelines that involve NodeJS scripts. For example, take a simple script that prints out 10 lines:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="cf">for</span>(<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> <span class="op">++</span>i) <span class="va">console</span>.<span class="at">log</span>(i)</a></code></pre></div>
<p>NodeJS will print an error message if the output is truncated:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1">$ <span class="fu">cat</span> t.js</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">for(</span><span class="ex">var</span> i = 0<span class="kw">;</span> <span class="ex">i</span> <span class="op">&lt;</span> 10<span class="kw">;</span> <span class="ex">++i</span><span class="kw">)</span> <span class="ex">console.log</span>(i)</a>
<a class="sourceLine" id="cb2-3" title="3">$ <span class="ex">node</span> --version</a>
<a class="sourceLine" id="cb2-4" title="4"><span class="ex">v6.11.1</span></a>
<a class="sourceLine" id="cb2-5" title="5">$ <span class="ex">node</span> t.js  <span class="kw">|</span> <span class="fu">head</span> -n 1</a>
<a class="sourceLine" id="cb2-6" title="6"><span class="ex">0</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="ex">events.js</span>:160</a>
<a class="sourceLine" id="cb2-8" title="8">      <span class="ex">throw</span> er<span class="kw">;</span> <span class="ex">//</span> Unhandled <span class="st">&#39;error&#39;</span> event</a>
<a class="sourceLine" id="cb2-9" title="9">      ^</a>
<a class="sourceLine" id="cb2-10" title="10"></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="ex">Error</span>: write EPIPE</a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="ex">at</span> exports._errnoException (util.js:1018:11)</a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="ex">at</span> WriteWrap.afterWrite (net.js:800:14)</a></code></pre></div>
<p>The process will cleanly exit if you require the module:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1">$ <span class="fu">cat</span> t.js</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="ex">require</span>(<span class="st">&quot;exit-on-epipe&quot;</span>);</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">for(</span><span class="ex">var</span> i = 0<span class="kw">;</span> <span class="ex">i</span> <span class="op">&lt;</span> 10<span class="kw">;</span> <span class="ex">++i</span><span class="kw">)</span> <span class="ex">console.log</span>(i)</a>
<a class="sourceLine" id="cb3-4" title="4">$ <span class="ex">node</span> t.js  <span class="kw">|</span> <span class="fu">head</span> -n 1</a>
<a class="sourceLine" id="cb3-5" title="5"><span class="ex">0</span></a></code></pre></div>
<h2 id="installation">Installation</h2>
<p>With <a href="https://www.npmjs.org/package/exit-on-epipe">npm</a>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1">$ <span class="ex">npm</span> install exit-on-epipe</a></code></pre></div>
<h2 id="usage">Usage</h2>
<p>For basic scripts, requiring at the top of the source file suffices:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="at">require</span>(<span class="st">&#39;exit-on-epipe&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co">// ... rest of source</span></a></code></pre></div>
<p>For more advanced situations (e.g.Â handing other streams), call the module:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">var</span> eoepipe <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;exit-on-epipe&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="at">eoepipe</span>(stream)<span class="op">;</span>            <span class="co">// will exit process on an EPIPE error on stream</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="at">eoepipe</span>(stream<span class="op">,</span> handler)<span class="op">;</span>   <span class="co">// will call handler() instead of process.exit</span></a></code></pre></div>
<h2 id="interface">Interface</h2>
<p>The module exports a single function (exposed as the variable <code>eoepipe</code>).</p>
<p><code>eoepipe(stream, bail)</code> will attach an error handler to <code>stream</code> which will:</p>
<ul>
<li>call the <code>bail</code> function if the error <code>.code</code> is <code>"EPIPE"</code> or <code>.errno</code> is <code>32</code></li>
<li>defer to the default behavior if there are no other error handlers</li>
<li>noop if the error is not <code>EPIPE</code> and if there are other error handlers</li>
</ul>
<p>If the <code>bail</code> function is not specified, <code>process.exit</code> is used.</p>
<p>If the <code>stream</code> parameter is not specified, no action will be taken</p>
<h2 id="notes">Notes</h2>
<p>The script will not perform any action if <code>process</code> or <code>process.stdout</code> are not available. It is safe to use in a web page.</p>
<h2 id="license">License</h2>
<p>Please consult the attached LICENSE file for details. All rights not explicitly granted by the Apache 2.0 license are reserved by the Original Author.</p>
<h2 id="badges">Badges</h2>
<p><a href="https://travis-ci.org/SheetJS/node-exit-on-epipe"><img src="https://travis-ci.org/SheetJS/node-exit-on-epipe.svg?branch=master" alt="Build Status" /></a></p>
<p><a href="https://npmjs.org/package/exit-on-epipe"><img src="https://img.shields.io/npm/l/exit-on-epipe.svg" alt="npm license" /></a></p>
<p><a href="https://npmjs.org/package/exit-on-epipe"><img src="https://img.shields.io/npm/dt/exit-on-epipe.svg" alt="NPM Downloads" /></a></p>
<p><a href="https://david-dm.org/sheetjs/node-exit-on-epipe"><img src="https://david-dm.org/sheetjs/node-exit-on-epipe/status.svg" alt="Dependencies Status" /></a></p>
<p><a href="https://ghit.me/repo/sheetjs/node-exit-on-epipe"><img src="https://ghit.me/badge.svg?repo=sheetjs/node-exit-on-epipe" alt="ghit.me" /></a></p>
<p><a href="https://github.com/SheetJS/node-exit-on-epipe"><img src="https://ga-beacon.appspot.com/UA-36810333-1/SheetJS/node-exit-on-epipe?pixel" alt="Analytics" /></a></p>
